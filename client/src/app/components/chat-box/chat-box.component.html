<div #scrollMe class="flex chat-box py-2 border-20 border-transparent flex-col">
    <div class="h-100">
        <!-- Load More Butonu -->
        @if(chatService.chatMessages().length > 5){
        <div class="text-center py-1 sticky top-0 w-full z-10">
            <button
                class="text-gray-500 text-xs shadow px-5 py-2 rounded-full bg-gray-200 hover:text-gray-700 focus:outline-none transition-colors">
                @if(chatService.isLoading()){
                <div class="flex items-center gap-2">
                    <mat-spinner diameter="20" strokeWidth="3"></mat-spinner> Loading
                </div>
                }@else { Load More }
            </button>
        </div>
        }

        @for (item of chatService.chatMessages(); track item.id) {

        <!-- <div style="background: #333; color: #0f0; padding: 10px; font-size: 10px; margin-bottom: 10px;">
            <strong>DEBUG - Mesaj ID: {{ item.id }}</strong>
            <pre>{{ item | json }}</pre>
        </div> -->
        <!-- Mesaj Hizalama -->
        <div class="flex mb-3 flex-row items-center"
            [class.justify-normal]="item.senderId !== authService.currentUser()?.id"
            [class.justify-end]="item.senderId === authService.currentUser()?.id">

            <!-- Karşı Tarafın Profil Resmi -->
            @if(item.senderId !== authService.currentUser()?.id){
            <div class="shrink-0 mr-2 mb-1">
                <img [src]="item.senderProfileImage ? item.senderProfileImage : 'https://ui-avatars.com/api/?name=' + (item.senderUserName || 'User') + '&background=random&color=fff'"
                    class="rounded-full h-8 w-8 object-cover border border-gray-200 shadow-sm bg-gray-100"
                    onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=User&background=random&color=fff'"
                    [title]="item.senderUserName" />
            </div>
            }

            <!-- Mesaj Kutusu -->
            <div class="chat-message p-3 rounded-lg shadow-sm max-w-[70%] relative group"
                [class.bg-white]="item.senderId !== authService.currentUser()?.id"
                [class.bg-blue-600]="item.senderId === authService.currentUser()?.id"
                [class.text-white]="item.senderId === authService.currentUser()?.id">

                <!-- =========================== -->
                <!-- 1. RESİM GÖRÜNÜMÜ          -->
                <!-- =========================== -->
                @if(item.messageType === 'Image'){
                <div class="mb-2 relative">
                    <img [src]="'http://localhost:5000' + item.attachmentUrl"
                        class="rounded-lg max-h-60 object-cover w-full border border-black/10" alt="Görsel">

                    <!-- Resim İndirme Butonu -->
                    <button (click)="downloadFile(item.attachmentUrl)"
                        class="absolute bottom-2 right-2 z-10 bg-black/60 text-white p-2 rounded-full hover:bg-black/80 transition-all flex items-center justify-center shadow-md cursor-pointer"
                        title="İndir">
                        <mat-icon style="font-size: 20px;">download</mat-icon>
                    </button>
                </div>
                }

                <!-- =========================== -->
                <!-- 2. DOSYA GÖRÜNÜMÜ          -->
                <!-- =========================== -->
                @else if(item.messageType === 'File'){
                <div class="flex items-center gap-3 p-3 rounded mb-2 border transition-colors relative"
                    [class.bg-gray-100]="item.senderId !== authService.currentUser()?.id"
                    [class.bg-blue-500]="item.senderId === authService.currentUser()?.id"
                    [class.border-gray-200]="item.senderId !== authService.currentUser()?.id"
                    [class.border-blue-400]="item.senderId === authService.currentUser()?.id">

                    <div class="bg-white/20 p-2 rounded-full">
                        <mat-icon>description</mat-icon>
                    </div>

                    <div class="flex flex-col overflow-hidden max-w-37.5">
                        <span class="font-medium truncate text-sm" [title]="item.attachmentName">
                            {{ item.attachmentName || 'Dosya' }}
                        </span>
                        <span class="text-[10px] opacity-80">Ek Dosya</span>
                    </div>

                    <!-- Dosya İndirme Butonu -->
                    <button (click)="downloadFile(item.attachmentUrl)"
                        class="ml-auto p-2 rounded-full flex items-center justify-center transition-colors shadow-sm cursor-pointer z-10"
                        [class]="item.senderId !== authService.currentUser()?.id 
                            ? 'bg-gray-200 text-gray-700 hover:bg-gray-300' 
                            : 'bg-white/20 text-white hover:bg-white/30'" title="İndir">
                        <mat-icon style="font-size: 20px;">download</mat-icon>
                    </button>
                </div>
                }

                <!-- Metin İçeriği -->
                @if(item.content){
                <span class="text-sm block wrap-break-word whitespace-pre-wrap leading-relaxed">
                    {{ item.content }}
                </span>
                }

                <!-- Saat -->
                <div class="flex items-center justify-end gap-1 mt-1 opacity-70">
                    <span class="text-[10px]">{{ item.createdDate | date:'shortTime' }}</span>
                    <!-- Okundu Bilgisi (Sadece bizim mesajlarımızda) -->
                    @if(item.senderId === authService.currentUser()?.id){
                    <mat-icon style="font-size: 14px; width: 14px; height: 14px;" [class.text-blue-200]="!item.isRead"
                        [class.text-green-300]="item.isRead">
                        {{ item.isRead ? 'done_all' : 'check' }}
                    </mat-icon>
                    }
                </div>
            </div>

            <!-- Bizim Profil Resmimiz -->
            @if(item.senderId === authService.currentUser()?.id){
            <div
                class="flex items-center justify-center h-10 w-10 rounded-full bg-linear-to-r from-blue-500 to-purple-500 shrink-0 ml-2">
                <img [src]="authService.currentUser()?.profileImage" class="rounded-full h-8 w-8 object-cover" />
            </div>
            }
        </div>
        }
    </div>
</div>